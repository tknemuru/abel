[Epic]
目的：
学習データ生成（learn-pre 等）の出力が「学習データ契約（learning-data-contract.md）」に適合していることを、テストで機械的に検証できる状態にする。
狙い：
壊れたときに即検知でき、原因切り分けができる土台（再現性・可観測性）を最優先で固める。

[Background / SoT]
1. 学習データ契約は docs/learning-data-contract.md を正とする。
2. 学習データ生成の責務境界は docs/arch.md の「abel: 学習データ生成まで」に従う。
3. 運用コマンドは docs/ops.md に記載の npm run learn-pre / learn-rage-pre / learn-collegial-pre を前提とする。
4. 本トピックは Phase 1 の A2（学習データ契約テスト）と、A1（最小スモーク）に限定する。

[Scope]
1. 学習データ生成物の契約テスト（Contract Tests）
  1.1 learn-pre（ability）を最低限の対象として契約検証を追加する。
  1.2 可能であれば learn-rage-pre / learn-collegial-pre も同じ枠組みで追加できる設計にする（ただし過剰拡張はしない）。
2. 最小スモークテスト基盤（Smoke）
  2.1 npm test で少なくとも1本のスモークが走り、契約テストが実行できる状態にする。
  2.2 既存の外部依存（netkeiba, IPAT, Jupyter）には触れない。学習データ生成の出力検証に集中する。

[Non-Goals]
1. 学習データ生成ロジックそのものの大改修はしない（契約検証を追加するだけ）。
2. Jupyter 脱却、予測基盤、購入（IPAT）系の変更は行わない。
3. スクレイピング強化、差分更新、購入リトライ強化など他バックログは含めない。

[Key Constraints]
1. 既存運用を壊さないこと（npm run learn-pre が従来通り動くこと）。
2. テストは外部サービスに依存しないこと（ネットワーク不要、IPAT不要、Jupyter不要）。
3. 失敗時に「何が契約違反か」をメッセージで分かるようにする（可観測性）。
4. 生成物のパス規約は契約に従う（resources/learnings 配下など）。
5. ディレクトリ未作成で落ちる既知の運用前提がある場合、テスト側で事前作成するか、検証の前提条件として明示する。

[Deliverables]
1. テスト基盤の最小セット
  1.1 npm test で実行されるテストランナー設定（既存があればそれを使用し、なければ最小導入）。
  1.2 テスト用の一時作業ディレクトリ戦略（本番 resources/ を汚さない工夫が望ましい。難しければクリーンアップ手順を必ず用意する）。
2. 学習データ契約テスト
  2.1 learn-pre 実行後に、契約上の生成物が存在することを検証する。
  2.2 input.csv の基本形式を検証する（CSV、UTF-8、ヘッダなし、改行LFの期待に沿うこと）。
  2.3 input-cols.json の存在と内容（配列または仕様に沿う構造）を検証する。
  2.4 relation.json の存在を検証する。
  2.5 行数の最低条件を置く（ゼロ件検知）。ゼロ件の場合は契約違反として落とす。
  2.6 ret0_race_id と ret0_horse_number がキーとして成立している前提を、relation 等から検査できる範囲で検証する（無理なら「検証不能な理由」と代替検査を明示）。
3. ドキュメント更新
  3.1 docs/ops.md にテスト実行方法と、テストが生成物を扱う前提（ディレクトリ作成、クリーンアップ）を追記する。
  3.2 必要であれば docs/learning-data-contract.md の「テスト観点（検証項目）」を追記する（契約の追認であり仕様変更ではない）。

[Definition of Done]
1. npm test がローカルで成功する。
2. learn-pre の生成物が契約に反する場合、テストが失敗し、原因がメッセージで分かる。
3. テスト実行でリポジトリが過度に汚れない（少なくともクリーンアップが用意される）。
4. 追加したテストと設定は最小で、他領域（購入・スクレイピング・予測）に影響を与えない。

[Verify]
1. npm ci（または既存手順に準拠）後に npm test を実行して成功すること。
2. npm run learn-pre を実行し、その後 npm test を実行して成功すること。
3. 意図的に生成物を削除または空にして npm test を実行し、契約違反として失敗することを確認する。

[Rollback]
このトピックで追加したテスト関連ファイルと設定変更を git revert で巻き戻せば元に戻る状態にする。
