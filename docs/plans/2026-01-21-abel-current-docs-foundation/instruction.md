# 目的
abel システム大規模改修の第一歩として、現行ソースを分析し、設計品質の土台となる必須ドキュメントを整備する。
本トピックでは「現行把握とドキュメント作成」のみを行い、新機能追加・挙動変更・UI追加・外部公開・DB拡張は行わない。

# 対象範囲
- リポジトリ内の現行実装（abel 本体）を主対象に調査する
- 別リポジトリ abel-learning が同一ワークスペースに存在する場合は併せて調査し、存在しない場合は「インタフェースとしての接続点（入出力・モデル受け渡し・依存物）」を abel 側から記述する
- スクレイピング（学習データ収集）、学習（モデル生成）、推論（予測）、購入（馬券自動購入）、通知（メール）、結果判定（的中判定）までの全体像をドキュメント化する

# 成果物（必須）
以下 3 点を必ず作成・更新する（なければ新規作成）。分量が増える場合は見出しで整理し、省略しない。
1) docs/spec.md（外部仕様）
2) docs/ops.md（運用手順）
3) docs/arch.md（設計境界・判断）

# 作業方針（重要）
- 推測で断定しない。根拠がソース・設定・ドキュメント上に存在する内容のみを「事実」として書く
- 不明点は「不明」「要確認」と明記し、確認方法（どこを見る/何を実行する）まで見える化する
- README や既存 docs がある場合は重複を避け、参照関係を整理してリンクする
- ドキュメントの目的は「今後の設計・改修のレビューができる状態」を作ること。実装の細部を写経しない（ただし運用に必要なコマンドや設定は具体的に書く）

# 調査の進め方（手順）
1. リポジトリ全体像の把握
   - ディレクトリ構成、主要モジュール/パッケージ、エントリポイント（CLI/cron/worker/web など）
   - 主要な設定ファイル（.env.example, config, YAML, JSON 等）と、必要な環境変数・シークレットの棚卸し
2. 主要フローの特定とトレース
   - 学習データ収集（スクレイピング）: 取得元、保存形式、実行タイミング、失敗時の挙動
   - 学習（abel-learning 連携）: 学習データの受け渡し、モデル生成物の形式・置き場所、バージョニング
   - 推論（予測）: 入力、モデル読み込み、出力（勝利確度等）、閾値の扱い
   - 購入（馬券自動購入）: 購入ロジック（条件・金額・券種等）、外部サービス/サイト連携、リトライ/冪等性
   - 通知（メール）: 送信タイミング（購入/結果）、テンプレ、失敗時、送信先管理
   - 結果（的中判定）: レース結果取得元、突合方法、結果通知
3. 外部インターフェースの整理
   - 外部サイト/API、メール送信基盤、スケジューラ、ストレージ、ログ/監視（あれば）
4. 依存方向・責務境界の抽出
   - コンポーネント単位の責務、依存方向、変更に強い境界/弱い境界
5. 運用観点の確認
   - セットアップ手順、日次運用、障害時の切り分け、再実行手順、バックアップ/復旧（存在すれば）

# docs/spec.md に書くこと（最低限）
- 目的 / 非目的
- ユースケース（ユーザ視点：予測→購入→通知→結果通知）
- 外部インターフェース（外部サイト/API、メール、スケジューラ、ファイル/DB 等）
- 主要フロー仕様（上記の 5 大フローを「入力→処理→出力」で）
- 制約・不変条件（例：購入の閾値、冪等性前提、再実行時の期待、データの一貫性など）
- 不明点/要確認リスト（確認方法付き）

# docs/ops.md に書くこと（最低限）
- セットアップ（必要ソフト、依存サービス、環境変数、初期データ、起動方法）
- 日常運用（定期実行の方法、ログの見方、正常系の確認ポイント）
- 監視・トラブルシューティング（よくある失敗モード、切り分け手順、再実行/リカバリ）
- バックアップ・復旧（対象データ、取得/復元手順。現状なければ「未整備」とし、最低限の方針案と TODO を明記）

# docs/arch.md に書くこと（最低限）
- コンポーネント責務（例：スクレイパ、特徴量/データ整形、学習連携、推論、購入、通知、結果判定 など）
- データフロー（テキストまたは Mermaid で可。学習データ→学習→モデル→推論→購入→通知→結果）
- 依存方向・不変条件（どこからどこに依存すべき/すべきでない、境界の理由）
- 設計判断とトレードオフ（現状の判断を事実ベースで列挙。根拠箇所への参照を付ける）
- 失敗時方針（リトライ、冪等性、部分失敗時の扱い、手動介入ポイント）

# 生成・更新ルール
- docs/ ディレクトリが無ければ作成する
- 既存 docs がある場合は、上記必須 3 ファイルに統合/参照整理する（情報を削らず構造で整理）
- 可能なら docs/README.md を追加し、3 ドキュメントへの導線を作る（任意だが推奨）

# 検証（Quality Gate）
- 3 ファイルが存在し、指定の章立て（少なくとも最低限項目）が埋まっている
- 主要フロー（収集/学習/推論/購入/通知/結果）が spec と arch で一貫している
- ops のセットアップ手順が「第三者が読んで作業できる」具体性（コマンド例、設定箇所、環境変数一覧）を満たす
- 不明点が「TODO の羅列」ではなく、確認方法まで書かれている
- ドキュメント内リンクが壊れていない（相対パス）

# 注意
- ここでは実装改修に着手しない（ドキュメント作成のみ）
- 挙動変更を伴う提案は docs/arch.md の「将来の改善余地（任意）」として分離し、現状事実と混ぜない
