# [RFC] システム概要ドキュメントの整備

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | Claude (AI) |
| **ステータス** | Accepted (承認済) |
| **作成日** | 2026-01-31 |
| **タグ** | docs, 中優先度 |
| **関連リンク** | CLAUDE.md（System Overview Documents 規約） |

## 1. 要約 (Summary)

- CLAUDE.md で定義されたシステム概要ドキュメント規約に基づき、`docs/architecture.md`・`docs/domain-model.md`・`docs/api-overview.md` の3ドキュメントを新規作成する。
- 既存の `docs/spec.md`（外部仕様書）と `docs/arch.md`（設計書）の内容を新ドキュメントに再編・統合し、統合完了後に両ファイルを削除する。
- `docs/ops.md`（運用手順書）と `docs/learning-data-contract.md`（学習データ契約書）はシステム概要とは異なる目的のドキュメントであるため、そのまま維持する。

## 2. 背景・動機 (Motivation)

- CLAUDE.md で IEEE 1016 の3ビューポイント（Structure / Data / Interface）に対応するドキュメント配置規約が定められているが、現状の abel リポジトリはこの規約に準拠していない。
- 現在 `docs/` 配下には4つのドキュメントが存在するが、規約が求めるドキュメント名・構成とは一致しない。

| 規約が求めるドキュメント | 対応するビューポイント | 現状 |
|---|---|---|
| `docs/architecture.md` | Structure | 存在しない（`arch.md` に類似内容あり） |
| `docs/domain-model.md` | Data | 存在しない（`arch.md`・`spec.md` に断片的に存在） |
| `docs/api-overview.md` | Interface | 存在しない（`spec.md`・`learning-data-contract.md` に断片的に存在） |

- `/rfc`・`/imp` 等のコマンドがシステム概要ドキュメントを参照する前提で設計されているため、規約通りのファイル名で配置しないとワークフロー上の不整合が生じる。
- 既存ドキュメントは情報が分散しており、同一の概念（例: 外部サービス一覧、DBスキーマ）が複数ファイルに重複して記述されている。

## 3. 目的とスコープ (Goals & Non-Goals)

### 目的 (Goals)

- CLAUDE.md のシステム概要ドキュメント規約に準拠した3ドキュメントを作成する。
- 既存ドキュメント（`spec.md`・`arch.md`）の有用な情報を漏れなく新ドキュメントに移行する。
- 既存ドキュメントの削除により、情報の重複・分散を解消する。

### やらないこと (Non-Goals)

- `docs/ops.md` の改廃（運用手順書はシステム概要ドキュメントの範囲外）。
- `docs/learning-data-contract.md` の改廃（システム間契約ドキュメントとして独立した役割がある）。
- ドキュメント内容の大幅な加筆・調査（既存情報の再編が主目的）。
- コードの変更。

## 4. 前提条件・依存関係 (Prerequisites & Dependencies)

- CLAUDE.md のシステム概要ドキュメント規約が確定していること（現時点で確定済み）。
- 既存ドキュメント（`spec.md`・`arch.md`・`ops.md`・`learning-data-contract.md`）の内容が最新であること。

## 5. 詳細設計 (Detailed Design)

### 5.1 既存ドキュメントと新ドキュメントの対応関係

既存4ドキュメントの各セクションを、新ドキュメントへどのようにマッピングするかを以下に示す。

#### docs/arch.md（設計書）→ 全内容を移行後、削除

| arch.md のセクション | 移行先 | 備考 |
|---|---|---|
| コンポーネント責務（ディレクトリ構成と責務） | `architecture.md` | そのまま移行 |
| 各コンポーネントの詳細 | `architecture.md` | そのまま移行 |
| データフロー | `architecture.md` | そのまま移行 |
| データの入出力形式 | `architecture.md` | そのまま移行 |
| 学習データ生成パイプライン | `architecture.md` | 責務境界の説明含む |
| 依存方向（ディレクトリ間依存） | `architecture.md` | そのまま移行 |
| 設計判断とトレードオフ | `architecture.md` | そのまま移行 |
| 失敗時方針（リトライ機構・購入状態管理・部分失敗時の扱い） | `domain-model.md` | 業務ルール・状態遷移として整理 |
| DB スキーマ概要 | `domain-model.md` | そのまま移行 |
| 将来の改善余地 | `architecture.md` | そのまま移行 |

#### docs/spec.md（外部仕様書）→ 全内容を移行後、削除

| spec.md のセクション | 移行先 | 備考 |
|---|---|---|
| 目的・非目的 | `domain-model.md` | システムのドメイン定義として記述 |
| ユースケース（日次運用フロー） | `domain-model.md` | ドメインの業務フローとして整理 |
| ユーザー操作 | `api-overview.md` | CLI エントリポイントとして整理 |
| 外部サービス | `api-overview.md` | 外部インターフェースとして整理 |
| データストア | `architecture.md` | 技術選定として整理 |
| 学習データインターフェース | `api-overview.md` | learning-data-contract.md への参照を記載 |
| 主要フロー仕様（全6フロー） | `api-overview.md` | CLI コマンドごとのフロー仕様として整理 |
| 制約・不変条件 | `domain-model.md` | 業務ルール・制約として整理 |
| 不明点/要確認リスト | 移行しない | 古い未解決項目は新ドキュメントに持ち込まない |

#### docs/ops.md（運用手順書）→ 変更なし、維持

運用手順書はシステム概要ドキュメント（Structure / Data / Interface）の範囲外であるため、そのまま維持する。

#### docs/learning-data-contract.md（学習データ契約書）→ 変更なし、維持

システム間のインターフェース契約として独立した文書価値がある。`api-overview.md` から参照リンクを記載する。

### 5.2 新ドキュメントの構成

#### docs/architecture.md（システム構造）

```markdown
# abel アーキテクチャ

## 技術スタック
  - Node.js, SQLite, Puppeteer, Jupyter 連携 等

## ディレクトリ構成と責務
  - arch.md「コンポーネント責務」セクションを移行

## データフロー
  - arch.md「データフロー」セクションを移行（mermaid 図含む）
  - arch.md「データの入出力形式」を移行
  - arch.md「学習データ生成パイプライン」を移行

## 依存関係
  - arch.md「依存方向」セクションを移行（mermaid 図含む）

## 設計判断とトレードオフ
  - arch.md「設計判断とトレードオフ」セクションを移行

## 将来の改善余地
  - arch.md「将来の改善余地」セクションを移行
```

#### docs/domain-model.md（ドメインモデル）

```markdown
# abel ドメインモデル

## システムの目的
  - spec.md「目的・非目的」を移行

## ドメイン概念と関係
  - 主要ドメインエンティティの定義と関係を整理
    （レース、馬、出走履歴、予測、購入、etc.）

## 業務フロー
  - spec.md「ユースケース（日次運用フロー）」を移行

## 業務ルール・制約
  - spec.md「制約・不変条件」を移行
  - arch.md「失敗時方針」（リトライ機構、部分失敗時の扱い）を移行

## 状態遷移
  - 購入状態（NotPurchased → Purchased → RaceFinished）を整理

## データ永続化（DB設計）
  - arch.md「DB スキーマ概要」を移行（テーブル・ビュー定義）
```

#### docs/api-overview.md（インターフェース設計）

```markdown
# abel インターフェース概要

## CLI エントリポイント
  - spec.md「ユーザー操作」を移行
  - 全 npm scripts コマンドの一覧と概要

## 主要フロー仕様
  - spec.md「主要フロー仕様」（全6フロー）を移行

## 外部サービス連携
  - spec.md「外部サービス」を移行
  - 各サービスとの接続方式・認証方式を整理

## システム間インターフェース
  - abel ↔ abel-learning 間のデータ連携概要
  - 詳細は learning-data-contract.md を参照
```

**[仮定]** abel は REST API を提供するサービスではないため、`api-overview.md` の「エンドポイント」は CLI コマンドエントリポイントとして、「認証方式」は外部サービスとの接続方式として読み替える。CLAUDE.md の「リポジトリの特性上不要な場合は省略可」に該当するレベルではないと判断し、abel の特性に合わせた内容で作成する。

### 5.3 ファイル操作の実行順序

1. `docs/architecture.md` を新規作成
2. `docs/domain-model.md` を新規作成
3. `docs/api-overview.md` を新規作成
4. `docs/spec.md` を削除
5. `docs/arch.md` を削除

## 6. 代替案の検討 (Alternatives Considered)

### 案A: 全ドキュメント統合（4ドキュメント → 3ドキュメント）

- **概要**: 既存の全4ドキュメント（spec.md, arch.md, ops.md, learning-data-contract.md）を新3ドキュメントに統合し、全て削除する。
- **長所**: `docs/` 配下が規約通りの3ファイルのみになり、構成が最もシンプルになる。
- **短所**:
  - `ops.md` の運用手順（セットアップ、日次運用、トラブルシューティング等）は Structure / Data / Interface のいずれにも自然に分類できない。無理に押し込むと各ドキュメントの目的が曖昧になる。
  - `learning-data-contract.md` は abel-learning との契約仕様であり、abel 単体のシステム概要とは目的が異なる。統合すると契約書としての参照性が低下する。

### 案B: 選択的統合 + 補助ドキュメント維持（推奨案）

- **概要**: `spec.md` と `arch.md` を新3ドキュメントに再編・統合して削除する。`ops.md` と `learning-data-contract.md` はそのまま維持する。
- **長所**:
  - 規約準拠の3ドキュメントが揃い、ワークフロー（`/rfc`, `/imp` 等）が正しく機能する。
  - 運用手順と契約仕様が独立した文書として参照性を維持する。
  - 情報の重複が解消される（`spec.md` と `arch.md` の重複内容が一元化される）。
- **短所**: `docs/` 配下が5ファイルになる（規約の3ファイル + 補助2ファイル）。

### 案C: 新規作成のみ（既存ドキュメントは全て維持）

- **概要**: 新3ドキュメントを作成するが、既存4ドキュメントは削除せず全て維持する。
- **長所**: 情報の喪失リスクがゼロ。
- **短所**:
  - 同一情報が複数ファイルに存在し、更新時にどちらを修正すべきか混乱する。
  - 「どのドキュメントが正（SoT）か」が不明確になり、メンテナンスコストが増大する。

### 選定理由

案Bを推奨する。理由は以下の通りである:

1. `ops.md` と `learning-data-contract.md` はシステム概要（Structure / Data / Interface）とは目的が明確に異なるため、無理に統合する合理性がない。
2. `spec.md` と `arch.md` は新3ドキュメントの内容と重複が大きく、分離したまま維持すると情報の二重管理が発生する。
3. CLAUDE.md 自体が「既存リポジトリやリポジトリの特性上不要な場合は省略可」と柔軟性を認めており、補助ドキュメントの併存は規約に反しない。

## 7. 横断的関心事 (Cross-Cutting Concerns)

本 RFC はドキュメントの再編のみであり、コード変更を伴わない。そのため、セキュリティ・スケーラビリティ・可観測性に関する影響はない。

### 7.4 マイグレーションと後方互換性

- `spec.md` および `arch.md` へのリンクが他のドキュメントや外部から存在する場合、リンク切れが発生する。
- 既知のリンク: `arch.md` 内の `learning-data-contract.md` への相対リンク → 新ドキュメントで再設定する。
- `ops.md` 内に `spec.md` / `arch.md` への参照がないことを確認済み。

## 8. テスト戦略 (Test Strategy)

コード変更を伴わないため、自動テストの対象外である。以下の手動検証を実施する。

- 新ドキュメント3ファイルが `docs/` 配下に存在すること。
- `spec.md`・`arch.md` が削除されていること。
- `ops.md`・`learning-data-contract.md` が変更されていないこと。
- 既存ドキュメントの全セクションが新ドキュメントのいずれかに移行されていること（「不明点/要確認リスト」を除く）。
- 新ドキュメント内のリンク（相対パス）が正しく機能すること。

## 9. 実装・リリース計画 (Implementation Plan)

### フェーズ

単一フェーズで実施する。ドキュメントのみの変更であり、段階的リリースの必要性がないため。

### 実装順序

1. `docs/architecture.md` を作成（`arch.md` の構造系セクション + `spec.md` のデータストア情報を統合）
2. `docs/domain-model.md` を作成（`arch.md` の DB・状態管理 + `spec.md` のドメイン情報を統合）
3. `docs/api-overview.md` を作成（`spec.md` のインターフェース情報を統合 + `learning-data-contract.md` への参照追加）
4. `docs/spec.md` を削除
5. `docs/arch.md` を削除
6. 手動検証（テスト戦略に記載の項目）

### 検証方法

- 各新ドキュメント作成後に、対応する既存セクションの移行漏れがないか確認する。
- 全ドキュメント完成後に、マッピング表（5.1節）と照合して網羅性を検証する。

### システム概要ドキュメントへの影響

本 RFC 自体が `docs/architecture.md`・`docs/domain-model.md`・`docs/api-overview.md` の新規作成を目的とするため、作成されるドキュメントが直接の成果物である。
